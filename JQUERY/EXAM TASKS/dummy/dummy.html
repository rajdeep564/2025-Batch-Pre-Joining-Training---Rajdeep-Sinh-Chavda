<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transaction Reconciliation</title>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">

    <style>
        .tabs {
            display: flex;
            justify-content: space-between;

        }

        .transaction-container {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }

        .transaction-list {
            border: 1px solid #ccc;
            width: 34%;
            min-height: 300px;
            padding: 10px;
        }

        .drop-zone {
            border: 2px dashed #007bff;
            border-radius: 10px;
            min-height: 150px;
            margin-top: 20px;
            width: 40%;
            margin: 10px;
        }

        #drophead {
            opacity: 0.5;
            font-weight: 100;
            font-style: oblique;
            display: flex;
            justify-content: center;
            position: relative;
            top: 30px;


        }


        .transaction-item {
            flex-direction: column;
            display: flex;
            background-color: #f8f9fa;
            padding: 10px;
            margin-bottom: 10px;
            cursor: move;
            align-content: center;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }

        .expanded {
            background-color: #e9ecef;
            margin-top: 10px;
        }

        .transaction-table {
            width: 100%;
            border-collapse: collapse;
        }

        .transaction-table td,
        .transaction-table th {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        #loading {
            display: none;
        }
    </style>
</head>

<body>

    <div class="container">
        <h2 class="my-4">Transaction Reconciliation</h2>

        <!-- Tabs Section -->
        <div class="tabs">
            <ul class="nav nav-tabs" id="transactionTabs">
                <li class="nav-item">
                    <a class="nav-link active" id="unreconciledTab" href="#">Unreconciled</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="reconciledTab" href="#">Reconciled</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="excludeTab" href="#">Exclude</a>
                </li>

            </ul>

            <button id="reconcileButton" class="btn btn-success" disabled>
                Reconcile
            </button>

        </div>


        <div class="transaction-container">
            <!-- Company 1 List -->
            <div id="company1List" class="transaction-list">
                <h4>Company 1</h4>
            </div>

            <!-- Center Drop Zone -->
            <div id="centreDropZone" class="drop-zone" ondrop="drop(event)" ondragover="allowDrop(event)">
                <h4 id="drophead">Drag transactions here</h4>
            </div>

            <!-- Company 2 List -->
            <div id="company2List" class="transaction-list">
                <h4>Company 2</h4>
            </div>



        </div>

        <!-- Expanded Transaction Table -->
        <div id="expandedTransaction" class="expanded"></div>

        <!-- Loading Spinner -->
        <div id="loading" class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    </div>

    <script>


        function switchTab(tabName) {
            const tabs = ['unreconciled', 'reconciled', 'exclude'];

            // Hide all tab content
            tabs.forEach(tab => {
                const tabContent = document.getElementById(`${tab}TabContent`);
                if (tabContent) {
                    tabContent.style.display = 'none';
                }
            });

            // Show the selected tab content
            const selectedTabContent = document.getElementById(`${tabName}TabContent`);
            if (selectedTabContent) {
                selectedTabContent.style.display = 'block';
            }

            // Update active tab link
            tabs.forEach(tab => {
                const tabLink = document.getElementById(`${tab}Tab`);
                if (tabLink) {
                    tabLink.classList.remove('active');
                }
            });
            const selectedTabLink = document.getElementById(`${tabName}Tab`);
            if (selectedTabLink) {
                selectedTabLink.classList.add('active');
            }

            // Load the appropriate transactions for the selected tab
            if (tabName === 'reconciled') {
                loadReconciledTransactions();
            } else {
                loadUnreconciledTransactions(); // Load unreconciled transactions if tab is 'unreconciled'
            }
        }


        function loadUnreconciledTransactions() {
            const company1List = document.getElementById('company1List');
            const company2List = document.getElementById('company2List');

            // Simulate the fetching of unreconciled transactions from localStorage or API
            const storedData = localStorage.getItem('transactionsData');
            if (storedData) {
                const data = JSON.parse(storedData);
                renderTransactionList(data.fromCompanyTransaction.filter(transaction => !transaction.isReconciled), 'Company 1', company1List);
                renderTransactionList(data.toCompanyTransaction.filter(transaction => !transaction.isReconciled), 'Company 2', company2List, true);
            }
        }

        // Function to load Reconciled Transactions
        function loadReconciledTransactions() {
            const company1List = document.getElementById('company1List');
            const company2List = document.getElementById('company2List');

            company1List.innerHTML = '';
            company2List.innerHTML = '';

            // Simulate the fetching of reconciled transactions from localStorage or API
            const storedData = localStorage.getItem('transactionsData');
            if (storedData) {
                const data = JSON.parse(storedData);
                showTransactionList(data.fromCompanyTransaction.filter(transaction => transaction.isReconciled), 'Company 1', company1List);
                showTransactionList(data.toCompanyTransaction.filter(transaction => transaction.isReconciled), 'Company 2', company2List, true);
            }
        }

        // Function to load Excluded Transactions
        function loadExcludedTransactions() {
            const company1List = document.getElementById('company1List');
            const company2List = document.getElementById('company2List');

            // Simulate the fetching of excluded transactions (if needed)
            // You can filter out excluded transactions if you have this data in localStorage
            const storedData = localStorage.getItem('transactionsData');
            if (storedData) {
                const data = JSON.parse(storedData);
                renderTransactionList(data.fromCompanyTransaction.filter(transaction => transaction.isExcluded), 'Company 1', company1List);
                renderTransactionList(data.toCompanyTransaction.filter(transaction => transaction.isExcluded), 'Company 2', company2List, true);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Add event listeners to each tab
            document.getElementById('unreconciledTab').addEventListener('click', () => switchTab('unreconciled'));
            document.getElementById('reconciledTab').addEventListener('click', () => switchTab('reconciled'));
            document.getElementById('excludeTab').addEventListener('click', () => switchTab('exclude'));

            // Initially render the unreconciled transactions (default tab)
            switchTab('unreconciled');
        });






        let currentPage = 1;
        const token = localStorage.getItem('jwt_token');

        // Fetch transactions for the current page
        async function fetchTransactions(page) {
            const url = `http://trainingsampleapi.satva.solutions/api/Reconciliation/GetTransaction?page=${page}`;

            try {
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch transactions');
                }

                const data = await response.json();
                console.log('Fetched Data:', data); // Log the complete structure of the data

                // Store the fetched data in localStorage
                localStorage.setItem('transactionsData', JSON.stringify(data));

                // Make sure the data has both fromCompanyTransaction and toCompanyTransaction
                const fromCompanyTransaction = data.fromCompanyTransaction || [];
                const toCompanyTransaction = data.toCompanyTransaction || [];
                return { fromCompanyTransaction, toCompanyTransaction }; // Return both arrays
            } catch (error) {
                console.error(error);
                return { fromCompanyTransaction: [], toCompanyTransaction: [] }; // Return empty arrays in case of error
            }
        }




        // Render transactions in the UI for both Company 1 and Company 2
        let selectedCompany1Transaction = null;
        let draggedCompany2Transactions = [];

        let fromCompanyTransaction = []; // Define these at a higher scope
        let toCompanyTransaction = [];


        // Function to render transactions
        function renderTransactions(data) {
            const company1List = document.getElementById('company1List');
            const company2List = document.getElementById('company2List');
            const centreDropZone = document.getElementById('centreDropZone');
            const reconcileButton = document.getElementById('reconcileButton');

            if (!company1List || !company2List || !centreDropZone || !reconcileButton) {
                console.error('Required elements not found');
                return;
            }

            console.log('Rendering Transactions:', data);

            company1List.innerHTML = '';
            company2List.innerHTML = '';

            const { fromCompanyTransaction, toCompanyTransaction } = data;

            // Filter transactions to show only those that are not reconciled or do not have the isReconciled property
            const filterUnreconciledTransactions = (transactions) => {
                return transactions.filter(transaction => !transaction.isReconciled);
            };

            // Function to render transaction list for each company

            // Handle drop event in the center zone
            const handleDrop = (event) => {
                event.preventDefault();

                // Get the dragged transaction data
                const transactionData = JSON.parse(event.dataTransfer.getData('text/plain'));

                // Log the dropped transaction data
                console.log('Dropped Transaction Data:', transactionData);

                // Ensure the amount exists in the transactionData
                if (!transactionData.amount) {
                    console.error('Amount is missing in the dropped transaction:', transactionData);
                    return;
                }

                // Find the selected Company 1 transaction
                const selectedTransactionDiv = document.querySelector('.transaction-item.selected');
                if (!selectedTransactionDiv) {
                    console.error('No transaction selected from Company 1');
                    return;
                }

                const selectedTransactionId = selectedTransactionDiv.dataset.transactionId;

                // Find the corresponding div in the center drop zone
                const company1TransactionDiv = document.querySelector(`.company1-matched-transaction[data-transaction-id="${selectedTransactionId}"]`);
                if (!company1TransactionDiv) {
                    console.error('No corresponding div found in the center for selected Company 1 transaction');
                    return;
                }

                // Add the dragged transaction to the dragged transactions array
                draggedCompany2Transactions.push(transactionData);

                // Create the dropped transaction element for Company 2
                const droppedTransaction = document.createElement('div');
                droppedTransaction.className = 'dropped-transaction';
                droppedTransaction.textContent = `${transactionData.transactionType} - $${transactionData.amount}`;
                droppedTransaction.style.backgroundColor = '#e9ecef';
                droppedTransaction.style.padding = '10px';
                droppedTransaction.style.marginBottom = '5px';
                droppedTransaction.style.borderRadius = '4px';
                droppedTransaction.style.border = '1px solid #ccc';

                // Set the data-amount attribute correctly
                droppedTransaction.dataset.amount = transactionData.amount;
                droppedTransaction.dataset.transactionId = transactionData.transactionId;  // <-- Correct this line

                // Log the data-amount attribute to confirm it's set
                console.log('Set data-amount for dropped transaction:', droppedTransaction.dataset.amount);

                // Add the dropped transaction inside the Company 1 matched div
                company1TransactionDiv.appendChild(droppedTransaction);

                // Store the dropped transaction amount in the element to be used later
                droppedTransaction.transactionData = transactionData;  // <-- Store the transaction data directly

                // Create and add the minus button
                const minusButton = document.createElement('button');
                minusButton.className = 'minus-btn';
                minusButton.textContent = '-';
                minusButton.style.marginLeft = '10px';
                minusButton.addEventListener('click', () => {
                    // Remove the transaction from the center
                    droppedTransaction.remove();

                    // Remove the dragged transaction from the array
                    const index = draggedCompany2Transactions.findIndex(item => item.transactionId === transactionData.transactionId);
                    if (index !== -1) {
                        draggedCompany2Transactions.splice(index, 1);
                    }

                    updateReconcileButtonState(); // Update reconcile button state
                });

                // Append the minus button to the dropped transaction
                droppedTransaction.appendChild(minusButton);

                // Adjust the height of the Company 1 matched div (this simulates adding transactions)
                company1TransactionDiv.style.height = `${company1TransactionDiv.offsetHeight + 60}px`;

                updateReconcileButtonState(); // Update reconcile button state
            };

            const handleDragOver = (event) => {
                event.preventDefault();
            };

            centreDropZone.addEventListener('dragover', handleDragOver);
            centreDropZone.addEventListener('drop', handleDrop);

            // Fetch and render only unreconciled transactions
            const unreconciledCompany1 = filterUnreconciledTransactions(fromCompanyTransaction);
            const unreconciledCompany2 = filterUnreconciledTransactions(toCompanyTransaction);

            console.log(unreconciledCompany1);
            console.log(unreconciledCompany2);

            renderTransactionList(unreconciledCompany1, 'Company 1', company1List);
            renderTransactionList(unreconciledCompany2, 'Company 2', company2List, true);

            // Save the updated transactions to local storage
            // localStorage.setItem('fromCompanyTransaction', JSON.stringify(fromCompanyTransaction));
            // localStorage.setItem('toCompanyTransaction', JSON.stringify(toCompanyTransaction));
        }



        //render transaction list

        const renderTransactionList = (transactions, company, listElement, isDraggable = false) => {

            const reconcileButton = document.getElementById('reconcileButton');
            reconcileButton.style.display = 'block';
            const centreDropZone = document.getElementById('centreDropZone');
            centreDropZone.style.display = 'block';
            transactions.forEach(transaction => {
                console.log(transaction);
                if (!transaction.transactionId || !transaction.transactionType || !transaction.amount || !transaction.lines) {
                    console.error('Transaction is missing expected fields:', transaction);
                    return;
                }





                const transactionItem = document.createElement('div');
                transactionItem.className = 'transaction-item';
                transactionItem.dataset.transactionId = transaction.transactionId;

                if (company === 'Company 1') {
                    transactionItem.style.backgroundColor = '#f1f1f1'; // Light gray for Company 1
                }

                // Add a click event to select the transaction from Company 1
                if (company === 'Company 1') {
                    transactionItem.addEventListener('click', () => {
                        // Deselect previously selected transaction
                        const selectedItems = document.querySelectorAll('.transaction-item.selected');
                        selectedItems.forEach(item => {
                            item.classList.remove('selected');
                            item.style.border = 'none'; // Remove green border
                        });

                        // Add green border to selected transaction
                        transactionItem.classList.add('selected');
                        transactionItem.style.border = '2px solid green'; // Green border for selected transaction

                        // Update the selected transaction
                        selectedCompany1Transaction = transaction;

                        // Check if the transaction already has a div in the centre drop zone
                        let company1TransactionDiv = document.querySelector(`.company1-matched-transaction[data-transaction-id="${transaction.transactionId}"]`);
                        if (!company1TransactionDiv) {
                            company1TransactionDiv = document.createElement('div');
                            company1TransactionDiv.className = 'company1-matched-transaction';
                            company1TransactionDiv.dataset.transactionId = transaction.transactionId;
                            company1TransactionDiv.style.backgroundColor = '#f8f9fa';
                            company1TransactionDiv.style.padding = '10px';
                            company1TransactionDiv.style.marginTop = '15px';
                            company1TransactionDiv.style.border = '1px solid #ccc';



                            const label = document.createElement('span');
                            label.className = 'company1-label';
                            label.textContent = `Company 1 Transaction ID: ${transaction.transactionId}`;
                            company1TransactionDiv.appendChild(label);


                            centreDropZone.appendChild(company1TransactionDiv);
                            const headingofcentrediv = document.getElementById('drophead');
                            headingofcentrediv.style.display = 'none'
                        }

                        updateReconcileButtonState();
                    });
                }

                // Handle draggable transactions for Company 2
                if (isDraggable) {
                    transactionItem.draggable = true;
                    transactionItem.addEventListener('dragstart', (e) => {
                        e.dataTransfer.setData('text/plain', JSON.stringify(transaction));
                    });
                }

                const leftWrapper = document.createElement('div');
                leftWrapper.className = 'left-wrapper';
                leftWrapper.style.display = 'flex';
                leftWrapper.style.justifyContent = 'space-between';
                leftWrapper.style.alignItems = 'center';
                leftWrapper.style.width = '100%';

                const transactionText = document.createElement('div');
                transactionText.innerHTML = ` 
                <strong>${transaction.transactionType}</strong>: ${transaction.date} - $${transaction.amount} - tId : ${transaction.transactionId}
            `;
                leftWrapper.appendChild(transactionText);

                const expandButton = document.createElement('button');
                expandButton.className = 'btn btn-primary';
                expandButton.textContent = 'Expand';
                expandButton.setAttribute('data-bs-target', `#transaction-details-${transaction.transactionId}`);
                expandButton.setAttribute('data-bs-toggle', 'collapse');
                leftWrapper.appendChild(expandButton);

                const expandedDetails = document.createElement('div');
                expandedDetails.className = 'collapse';
                expandedDetails.id = `transaction-details-${transaction.transactionId}`;

                const tableWrapper = document.createElement('div');
                tableWrapper.className = 'table-wrapper';
                tableWrapper.style.display = 'flex';
                tableWrapper.style.justifyContent = 'flex-end';

                const table = document.createElement('table');
                table.className = 'transaction-table table table-bordered';
                const tableHeader = `
                <thead>
                    <tr><th>Line ID</th><th>Account</th><th>Debit</th><th>Credit</th></tr>
                </thead>
            `;
                table.innerHTML = tableHeader;

                transaction.lines.forEach(line => {
                    const row = table.insertRow();
                    row.insertCell(0).innerText = line.lineId;
                    row.insertCell(1).innerText = line.account;

                    if (line.isCredit) {
                        row.insertCell(2).innerText = '';
                        row.insertCell(3).innerText = `$${line.amount}`;
                    } else {
                        row.insertCell(2).innerText = `$${line.amount}`;
                        row.insertCell(3).innerText = '';
                    }
                });

                tableWrapper.appendChild(table);
                expandedDetails.appendChild(tableWrapper);

                transactionItem.appendChild(leftWrapper);
                transactionItem.appendChild(expandedDetails);

                listElement.appendChild(transactionItem);
            });
        };



        // show transavtction list 

        const showTransactionList = (transactions, company, listElement, isDraggable = false) => {
            const centreDropZone = document.getElementById('centreDropZone');
            centreDropZone.style.display = 'none';

            const reconcileButton = document.getElementById('reconcileButton');
            reconcileButton.style.display = 'none';
            transactions.forEach(transaction => {
                console.log(transaction);
                if (!transaction.transactionId || !transaction.transactionType || !transaction.amount || !transaction.lines) {
                    console.error('Transaction is missing expected fields:', transaction);
                    return;
                }





                const transactionItem = document.createElement('div');
                transactionItem.className = 'transaction-item';
                transactionItem.dataset.transactionId = transaction.transactionId;

                const leftWrapper = document.createElement('div');
                leftWrapper.className = 'left-wrapper';
                leftWrapper.style.display = 'flex';
                leftWrapper.style.justifyContent = 'space-between';
                leftWrapper.style.alignItems = 'center';
                leftWrapper.style.width = '100%';

                const transactionText = document.createElement('div');
                transactionText.innerHTML = ` 
                <strong>${transaction.transactionType}</strong>: ${transaction.date} - $${transaction.amount} - tId : ${transaction.transactionId}
            `;
                leftWrapper.appendChild(transactionText);

                const expandButton = document.createElement('button');
                expandButton.className = 'btn btn-primary';
                expandButton.textContent = 'Expand';
                expandButton.setAttribute('data-bs-target', `#transaction-details-${transaction.transactionId}`);
                expandButton.setAttribute('data-bs-toggle', 'collapse');
                leftWrapper.appendChild(expandButton);

                const expandedDetails = document.createElement('div');
                expandedDetails.className = 'collapse';
                expandedDetails.id = `transaction-details-${transaction.transactionId}`;

                const tableWrapper = document.createElement('div');
                tableWrapper.className = 'table-wrapper';
                tableWrapper.style.display = 'flex';
                tableWrapper.style.justifyContent = 'flex-end';

                const table = document.createElement('table');
                table.className = 'transaction-table table table-bordered';
                const tableHeader = `
                <thead>
                    <tr><th>Line ID</th><th>Account</th><th>Debit</th><th>Credit</th></tr>
                </thead>
            `;
                table.innerHTML = tableHeader;

                transaction.lines.forEach(line => {
                    const row = table.insertRow();
                    row.insertCell(0).innerText = line.lineId;
                    row.insertCell(1).innerText = line.account;

                    if (line.isCredit) {
                        row.insertCell(2).innerText = '';
                        row.insertCell(3).innerText = `$${line.amount}`;
                    } else {
                        row.insertCell(2).innerText = `$${line.amount}`;
                        row.insertCell(3).innerText = '';
                    }
                });

                tableWrapper.appendChild(table);
                expandedDetails.appendChild(tableWrapper);

                transactionItem.appendChild(leftWrapper);
                transactionItem.appendChild(expandedDetails);

                listElement.appendChild(transactionItem);
            });
        };





        const selectTransactionFromCompany1 = (transactionElement) => {
            const previouslySelected = document.querySelector('.selected-transaction');
            if (previouslySelected) {
                previouslySelected.classList.remove('selected-transaction'); // Remove the class from previously selected
            }

            // Add the selected-transaction class to the newly selected transaction
            transactionElement.classList.add('selected-transaction');
        };


        // Reconcile button click handler
        const reconcileClicked = () => {
            const company1List = document.getElementById('company1List');
            const centreDropZone = document.getElementById('centreDropZone');

            const selectedCompany1Transaction = document.querySelector('.selected');
            const matchedCompany1TransactionId = selectedCompany1Transaction ? selectedCompany1Transaction.dataset.transactionId : null;

            // Check if a transaction from Company 1 is selected
            if (!matchedCompany1TransactionId) {
                alert('Please select a transaction from Company 1 first.');
                return;
            }

            // Check if there are any dropped transactions for Company 2 in the centre
            const droppedTransactions = centreDropZone.querySelectorAll('.dropped-transaction');
            if (droppedTransactions.length === 0) {
                alert('Please drag and drop transactions from Company 2.');
                return;
            }

            // Calculate the total amount of the dropped transactions from Company 2
            let totalCompany2Amount = 0;
            droppedTransactions.forEach(transaction => {
                // Log the full transaction data to ensure we have access to all properties
                console.log('Dropped Transaction Data:', transaction.transactionData);

                // Access the amount from transactionData (not dataset)
                const transactionAmount = parseFloat(transaction.transactionData.amount);  // Ensure it's a number
                totalCompany2Amount += transactionAmount;
                console.log('Total Company 2 Amount:', totalCompany2Amount);
            });

            console.log('Matched Transaction ID:', matchedCompany1TransactionId);
            console.log('Company 1 Transactions:', fromCompanyTransaction);

            // Get the selected Company 1 transaction
            const selectedTransaction = fromCompanyTransaction.find(transaction => transaction.transactionId === parseInt(matchedCompany1TransactionId));
            console.log(selectedTransaction);

            // Check if the amounts match between Company 1 and the dropped Company 2 transactions
            if (selectedTransaction.amount !== totalCompany2Amount) {
                alert('The amounts do not match. Cannot reconcile.');
                return;
            }

            // Mark the selected Company 1 transaction as reconciled
            selectedTransaction.isReconciled = true;

            // Update the Company 2 transactions as reconciled
            droppedTransactions.forEach(transaction => {
                const transactionId = parseInt(transaction.transactionData.transactionId);  // Access transactionData
                const company2Transaction = toCompanyTransaction.find(t => t.transactionId === transactionId);
                if (company2Transaction) {
                    company2Transaction.isReconciled = true; // Mark the Company 2 transaction as reconciled
                }
            });

            // Store the updated transactions in localStorage (for both companies)
            const data = {
                fromCompanyTransaction, // Updated Company 1 transactions
                toCompanyTransaction,   // Updated Company 2 transactions
            };

            localStorage.setItem('transactionsData', JSON.stringify(data)); // Update the stored data

            // Disable the reconcile button after clicking
            document.getElementById('reconcileButton').disabled = true;

            // Clear the center zone or perform any other actions like resetting the lists or UI
            resetCentreDropZone();
            renderTransactions(data);

            alert('Transactions reconciled successfully!');
        };


        // Function to reset the center drop zone (if needed)
        const resetCentreDropZone = () => {
            const centreDropZone = document.getElementById('centreDropZone');
            centreDropZone.innerHTML = ''; // Clear the drop zone
        };

        // Reconcile button logic to enable/disable based on amounts
        const checkReconcileButton = () => {
            const selectedCompany1Transaction = document.querySelector('.selected-transaction');
            const matchedCompany1TransactionId = selectedCompany1Transaction ? selectedCompany1Transaction.dataset.transactionId : null;

            if (!matchedCompany1TransactionId) {
                document.getElementById('reconcileButton').disabled = true;
                return;
            }

            // Check if there are any dropped transactions for Company 2 in the centre
            const droppedTransactions = document.getElementById('centreDropZone').querySelectorAll('.dropped-transaction');
            if (droppedTransactions.length === 0) {
                document.getElementById('reconcileButton').disabled = true;
                return;
            }

            // Calculate the total amount of the dropped transactions from Company 2
            let totalCompany2Amount = 0;
            droppedTransactions.forEach(transaction => {
                const transactionAmount = parseFloat(transaction.dataset.amount);
                totalCompany2Amount += transactionAmount;
            });

            // Get the selected Company 1 transaction
            const selectedTransaction = fromCompanyTransaction.find(transaction => transaction.transactionId === parseInt(matchedCompany1TransactionId));

            // Enable the reconcile button only if amounts match
            if (selectedTransaction.amount === totalCompany2Amount) {
                document.getElementById('reconcileButton').disabled = false;
            } else {
                document.getElementById('reconcileButton').disabled = true;
            }
        };

        document.getElementById('reconcileButton').addEventListener('click', reconcileClicked);




        // Function to update the reconcile button state
        function updateReconcileButtonState() {
            const reconcileButton = document.getElementById('reconcileButton');

            if (!selectedCompany1Transaction || draggedCompany2Transactions.length === 0) {
                reconcileButton.disabled = true;
                return;
            }

            // Calculate the total amount of the dragged transactions from Company 2
            const totalDraggedAmount = draggedCompany2Transactions.reduce((total, transaction) => total + transaction.amount, 0);

            // Check if the total dragged amount matches the selected Company 1 transaction's amount
            if (selectedCompany1Transaction.amount === totalDraggedAmount) {
                reconcileButton.disabled = false;
            } else {
                reconcileButton.disabled = true;
            }
        }

        // Load transactions for the current page
        async function loadTransactions() {
            document.getElementById('loading').style.display = 'block';

            // Check if the data is already stored in localStorage
            const storedData = localStorage.getItem('transactionsData');

            // let fromCompanyTransaction = [];
            // let toCompanyTransaction = [];

            if (storedData) {
                // Parse the data from localStorage if it exists
                const data = JSON.parse(storedData);
                fromCompanyTransaction = data.fromCompanyTransaction || [];
                toCompanyTransaction = data.toCompanyTransaction || [];
            } else {
                // If no data in localStorage, fetch from the API
                const result = await fetchTransactions(currentPage);
                fromCompanyTransaction = result.fromCompanyTransaction;
                toCompanyTransaction = result.toCompanyTransaction;
            }

            // Render the transactions from either localStorage or API
            renderTransactions({ fromCompanyTransaction, toCompanyTransaction });

            document.getElementById('loading').style.display = 'none';
            currentPage++;
        }



        // Handle scroll to load more transactions (infinite scroll)
        // window.addEventListener('scroll', () => {
        //     if (window.innerHeight + window.scrollY >= document.body.offsetHeight) {
        //         loadTransactions();
        //     }
        // });

        // Start loading transactions when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            loadTransactions();
        });

        // Function to handle drag events
        function drag(event) {
            event.dataTransfer.setData("text", event.target.id);
        }

        // Allow drop on the center drop zone
        function allowDrop(event) {
            event.preventDefault();
        }

        // Handle drop event to expand transactions in the table
        function drop(event) {
            event.preventDefault();
            var data = event.dataTransfer.getData("text");
            var droppedTransaction = document.getElementById(data);

            // Create a new table row for the dropped transaction
            var transactionDetails = {
                account: "Accounts Payable",
                amount: droppedTransaction.innerText.includes('100') ? 100 : 200,
                isCredit: true,
                lineId: 1
            };

            // Add the dropped transaction to the expanded area
            expandTransaction(transactionDetails);
        }

        // Expand the transaction into a table in the expanded area
        function expandTransaction(transaction) {
            var expandedArea = document.getElementById("expandedTransaction");

            // Create the table if not created yet
            if (!expandedArea.querySelector(".transaction-table")) {
                var table = document.createElement("table");
                table.className = "transaction-table";
                var tableHeader = `<thead><tr><th>Account</th><th>Amount</th><th>Is Credit</th></tr></thead>`;
                table.innerHTML = tableHeader;
                expandedArea.appendChild(table);
            }

            // Append new row to the table
            var table = expandedArea.querySelector(".transaction-table");
            var row = table.insertRow();
            row.insertCell(0).innerText = transaction.account;
            row.insertCell(1).innerText = transaction.amount;
            row.insertCell(2).innerText = transaction.isCredit ? 'Yes' : 'No';
        }


        // switch tabs loading logic 










    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>